- name: ğŸš€ Deploy or Delete CloudFormation Stack for EKS with Fargate
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    stack_name: Project-Stack
    template_file: ../AWS-CF-Templates/main-stack.yaml
    region: ap-south-1
    state: present  # Change to 'absent' to delete the stack

  tasks:
    - name: ğŸ“¦ Manage CloudFormation Stack for EC2 and EKS
      amazon.aws.cloudformation:
        stack_name: "{{ stack_name }}"
        state: "{{ state }}"
        region: "{{ region }}"
        template_body: "{{ lookup('file', template_file) if state == 'present' else '' }}"
        capabilities:
          - CAPABILITY_NAMED_IAM
        tags:
          Environment: Dev
          Owner: DevOps
      register: stack_result

    - name: ğŸ§¾ Print full stack_result for debugging
      debug:
        var: stack_result

    - name: âœ… Print Outputs (when Present)
      when: state == 'present'
      block:
        - name: ğŸ” Print EKSClientInstanceId
          when: "'EKSClientInstanceId' in stack_result.stack_outputs"
          debug:
            msg: "âœ… EKSClientInstanceId: {{ stack_result.stack_outputs['EKSClientInstanceId'] }}"

        - name: ğŸ” Print EKSClientPublicIP
          when: "'EKSClientPublicIP' in stack_result.stack_outputs"
          debug:
            msg: "ğŸŒ EKSClientPublicIP: {{ stack_result.stack_outputs['EKSClientPublicIP'] }}"

        - name: ğŸ” Print EKS Cluster Name
          when: "'EKSClusterName' in stack_result.stack_outputs"
          debug:
            msg: "â˜¸ï¸ EKS Cluster Name: {{ stack_result.stack_outputs['EKSClusterName'] }}"

        - name: âœ… Stack deployed message
          debug:
            msg: "âœ… Stack '{{ stack_name }}' deployed successfully in region '{{ region }}'"

        - name: ğŸ§© Print Kubeconfig Generation Command
          debug:
            msg:
              - "ğŸ“„ To generate kubeconfig on the EC2 instance - first configure AWS credentials on the EKS client instance."
              - "ğŸ’» Command: aws eks update-kubeconfig --region {{ region }} --name {{ stack_result.stack_outputs['EKSClusterName'] }}"


    - name: ğŸ—‘ï¸ Stack deletion success message (Absent)
      when: state == 'absent'
      debug:
        msg: "ğŸ—‘ï¸ Stack '{{ stack_name }}' deleted successfully from region '{{ region }}'"
